                    AZ900 Microsoft Azure Cloud Fundamentals 2021
                    Course Notes Part 41


Configure Azure Firewall
  - In the portal, click on the Virtual Machines view over on the left
    - Here there is a virtual machine running, it's called eastwindowsvm1
    - If we take a look at the networking for this, it's in a network called EastVnet1 and more specifically in a subnet within that vnet called EastSubnet1
  - Having said that, if I go to my jumpbox virtual machine, which is running, and click on it and look at the networking
    - It's in the same virtual network, EastVnet1, but in a different subnet, in this case EastSubnet2
    - A jumpbox is normally used as a point for remote administration from the outside
    - We can make a connection from the Internet into the jumpbox, and from the jumpbox to other virtual machines on private networks.
  - What we are going to do then is take a look at my virtual network definition, because we've prepared something ahead of time
    - If we go into virtual networks on the left and open up one of our virtual networks here on the right, called EastVnet1
    - We've already created a subnet called AzureFirewallSubnet.
    - All one word, no spaces, and I've allocated it some address range that falls under the vnet range
    - You can either have this done ahead of time or you are prompted to create a new virtual network 
    - And a subnet with this name when you build the Azure Firewall, as you'll see pretty much now
  - Click Create a resource in the upper left to begin building the firewall, search for firewall
    - Select it from the list and click Create, we want to put this in an existing resource group that we've already got created
    - We are going to call this Fw1 for firewall1, and in this case I'll put in the proper region 
    - And here's where you have the option to create a new virtual network or use an existing one
    - It wants to call it, the subnet at least within the Vnet, AzureFirewallSubnet
    - We've already done that, so if choosing Use existing, if we use existing Vnet, let's say I chose Vnet2 here
    - Notice it says you need to have a subnet called AzureFirewallSubnet
    - Well that Vnet doesn't but EastVnet1 does, and so we don't get that message any longer
    - Remember that an Azure Firewall has a public IP address so it needs to create that resource
    - Call this Fw1PubIP and then click Review and create, it'll check.
  - Once the validation has passed, click Create, as we are in the midst of creating the firewall we can see that the deployment is underway.
    - While that's happening, click Create a resource because what we need to create is a route table
    - We have to do this so we can direct any subnets that have resources that we want to go through our Azure Firewall
    - We need to define a route so that they are forced to so before traffic gets to the Internet
  - That's going to be our example, the Azure Firewall also controls inbound traffic from the Internet
    - Choose Route table and I'm going to click Create and call this example Fw1Rt1, firewall 1, router table 1
    - Place this in an existing resource group and in the same region or location and click Create
  - We're going to have to do two things here
    - Number one, we are going to have to create a route to the private IP address of my Azure Firewall
    - We are also going to have to associate the routing table with the subnet in question
    - Go to all resources here and type rt and there it is, Firewall 1 Rt1, our routing table.
  - First thing that I'll do here is go to subnets and click Associate
    - We are going to choose EastVnet1 and we are interested in EastSubnet1
    - That has virtual machines on it and our goal is to limit their access to specific Internet locations based on the FQDN
    - Those virtual machines are in EastSubnet1 and we want them affected by this routing table, so go ahead and click OK
  - Then, we need to create a route
    - To do that, we need a private IP at the firewall
    - Go to all resources and filter by fw, there is Fw1, but we don't have the private IP address yet
    - Give it a moment until it's completely initialized, then we'll copy the private IP 
    - Because that needs to be in the routing table entry
    - And after a minute, we have now have a private IP address for this firewall, then just copy that
  - Go back to virtual networks for a moment and let's open up EastVnet1, and let's click Connected devices.
    - We can see that our firewall device, firewall 1 is connected to a subnet called AzureFirewallSubnet
    - We've got our jumpbox connected to EastSubnet2, we are going to reach into that jumpbox
    - Then from it we will connect to the private IP address for our Windows virtual machine running in EastSubnet2
    - Then go back to our routing table and get this all figured out and working
    - Go to All resources and ilter it for rt, there's our routing table
    - We've already associated with EastSubnet1, go to Routes and Add a route
    - Call this firewall1 default and the address prefix here for the default route is 0.0.0.0/0
    - The actual firewall is considered a virtual appliance in here, we're going to give it the private IP address and click OK.
  - We've used remote desktop to RDP into my jumpbox and through it RDP to the private IP address of a Windows computer 
    - That is on a subnet affected by our default route to our firewall
    - What you are going to notice then on those machines, like if you go to the command prompt 
    - If you try to ping something on the Internet, let's say www.google.com, you are not going to get a response back
    - But you would from your jumpbox, of course, because it's reachable from the Internet
    - So if we were to open a web browser here on this computer, and for example just try to go to cnn.com
    - Notice, we get an action of deny being shown here which is No rule matched
    - Tthe default rule blocks connectivity if say we want to allow access to cnn.com, we are going to have to make an application rule that will allow that
  - Back in the Azure portal, in the All resources view, filter for things that have fw in the name
    - Let see, firewall 1, Rules, Application rule collection, Add application rule collection
    - Call this example AllowedEntertainment and give it a rule priority
    - In this case, it's the only one rule we have, so 100
    - We want to allow, and the name here will be AllowHBO or CNN or whatever it is, in this case CNN
    - Let's say the source address is any, protocols and ports http,https, and the target FQDN will be star dot cnn.com and click Add
    - Once it's updated that firewall rule, go back to that client station and retry the connection to cnn.com.
  - After a moment we can see we're able to pop up the web page because now that is listed as an allowed FQDN through our Azure Firewall
    - Although if we try to go to other sites here, eg going to google.com, again we get an action of deny and we don't get access to the webpage.


Azure DDoS Mitigation
  - A distributed denial of service attack is executed by an attacker
    - These machines would have been infected perhaps by tricking users into following links to websites that contain malicious code
    - Or email messages that have infected file attachments, and the like
    - The idea is that the attacker has control of all of these machines and these machines are called zombies or bots
  - They are organized into what is referred to as a botnet, a collection of computers under the control of an attacker
    - Often, if you actually search around the dark web, you will come across sites where these are for sale
    - You can rent the use of a botnet to execute a DDoS attack against, for example, a website or even a competitor to make their web application unavailable
    - Or even if you're a malicious person, to demand ransom, this is highly illegal, however, it does exist and it's a reality
  - We need to be able to mitigate this
    - So the attacker controls all of these bots organized into a botnet, which can render a website or an application useless for legitimate traffic
    - What can we do about this? Well, with a distributed denial of service attack, basic protection is automatically enabled for you in Microsoft Azure
    - There's no additional cost, but what does that mean?
  - Well, why don't we compare basic with standard, which does have a cost associated with it
    - You configure standard DDoS mitigation protection in the properties of an Azure virtual network, when you're in the properties blade.
  - So what happens then, is that based on the resources deployed in that Azure VNet
    - Microsoft Azure will tune protection against DDoS attacks against those resources
    - You also get alerts when DDoS attacks appear to be occurring against some of your deployed resources In those VNets.

