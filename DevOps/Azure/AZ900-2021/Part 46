                    AZ900 Microsoft Azure Cloud Fundamentals 2021
                    Course Notes Part 46


Azure Resource Locking Using the CLI
You can lock Azure resources to prevent deletion or modifications at the subscription, resource group, and individual resource level. You can do that in the portal or, as we're going to see here, we can also do that using the CLI using the az lock create command. So I'm going to name my lock Rg1Lock because I'm going to lock a resource group, which will also apply to the child items deployed within that resource group.
So then I'm going to use --lock-type. And I'm going to use CanNotDelete, so preventing deletion. And then I'm going to specify the resource group by name here of course, using --resource-group. And the resource group in question here I want to apply the locking to is Rg1. So I'm going to go ahead and press Enter. Now after a moment, we can see that it appears we have some output from that command that tells us that the lock is in place.
Let's clear the screen and let's verify this, by typing az space lock space list, this will show us any locks that we currently have in place. And here, we can see that it's called Rg1Lock. It's set to CannotDelete, and it's set for a particular resource group in this case, Rg1.
Here in the Azure portal, if I were to open up that resource group and view its properties blade and then click Locks. I would see here that we've got our lock here, Rg1Lock that we just created through the Azure CLI. So indeed, it is in effect.
I can also use the az lock show command, so I can view the id related to that lock. Which we see up here, we see the id. All I'm doing here is telling it I want to show something specific about a lock called Rg1Lock for a resource-group called Rg1.
And I'm going to control the output and view the id. So I'm going to query for the id, in other words only show me the id. And that's really essentially what we see up here at the top. So I'm going to go ahead and copy that, because what we can then do is use that id to remove the lock using az lock delete. And of course I can just use --ids and paste in or we can use a variable if we really wanted to.
But if I go ahead and remove the lock that way after that's completed, let's just clear the screen. If I run az lock list, if we spell that correctly that would be superb, so az space lock space list, there we are. Then we're going to get a whole lot of nothing returned because we no longer have a resource lock, we have removed it.


Azure Resource Locking Using PowerShell
In this demonstration, I'm going to use Microsoft PowerShell to manage Azure resource locks. Resource locking is helpful if you want to prevent unwanted modifications or the deletion of Azure resources. And we can set locking at the subscription resource group or at the resource level. So here in the PowerShell ISE, I've already got a script here, where in line 1 I'm creating or locking a resource using the New-AzResourceLock PowerShell commandlet.
So I have to provide a name for this lock. So I'm calling this Rg1, for resource group 1, NoDelete. And the LockLevel here will be CannotDelete, but I can also specify that I want to prevent modifications as opposed to deletions. And here the resource group name to which I want this applied is called rg1.
So let's go ahead and execute that one line by putting our cursor on the line somewhere here in the ISE and then clicking the Run Selection button. I get a prompt, are you sure you want to create that lock? Yes, so I'll click Yes. And after a moment it appears that it's done. Why don't we check our work in the portal?
Here in the portal, I'm in the resource groups view. There's Rg1, so I'll click on it. And in the Properties blade, I'll click Locks. Here we could see we've got the Rg1NoDelete lock name that we just specified and applied from PowerShell.
Now, of course, here in PowerShell, we can view any current lock configuration using the Get-AzResourceLock commandlet. So I'm going to clear the screen down below, then I'm going to click on line 3 here to run Get-AzResourceLock. And, again, we can see here it is. We've only got one here, it's called Rg1NoDelete. And we know that it will be applied specifically to our resource group called rg1.
Now, the next thing I want to do is remove that lock. So the first thing I can do here is create a variable. Creating a variable here called lockId. And I'm going to run Get-AzResourceLock and going to specify the ResourceGroupName. And then I'm going to refer to the .LockID property. Now, the reason that I've got the open and closed parentheses here is because I need some way to tell Powershell that what is within the parentheses is part of one expression, one statement in PowerShell.
Then after that, I want to refer to a property. Because if I don't have the parentheses around it, it's going to think that rg1.LockId is a parameter value, when really the only parameter value here for ResourceGroupName is rg1. So the result of that, the ID, the LockId, will be put in the LockId variable. And so after that in line 7, we can simply remove it using Remove-AzResourceLock. Just tell up a LockId based on the variable that we've created back up here in line 5. So I'm going to select those lines of code in my script here and I'm going to click the Run Selection button.
Then I get a prompt. Are you sure you want to delete that? Sure, yes, I am.
And it looks like it's good. Why don't we verify our work by running Get-AzResourceLock? We get a whole lot of nothing. And why don't we just check it just for fun in the Azure portal. Why not? So here in the portal, I'm just going to open up that resource group and look at Locks, and we now see it says, this resource has no locks.


Common Data Privacy Frameworks
  - Data privacy has a big impact on organizational security policies especially as related to cloud computing. We have to consider the types of data that we need to safeguard using data privacy frameworks. Data such as Personally Identifiable Information otherwise called P-I-I or PII, Protected Health Information, PHI.
  - Data that resides within specific national boundaries might be subject to specific laws and regulations. But then we need to consider data that's being transmitted into a country from elsewhere, and also data being transmitted out of a country. With data privacy frameworks, the first consideration is Personally Identifiable Information or PII, which would include things like a person's phone number, their credit history, their mother's maiden name, their social security number, their credit card number, and so on.
So essentially, whatever can uniquely identify an individual in some way is called Personally Identifiable Information. Then on the right, we've got Protected Health Information which is more medically related. It would include things such as a patient's name, medical discharge dates, medical payments, past procedures, drugs that had been administered, and so on.
And so in relation to this type of information, we have to consider data privacy frameworks which outline how the data will be collected, how the data will be used. And whether or not the data will be shared with third parties. And often users must supply consent to some or all of these activities. And, there are also maybe laws and regulations that stipulate that this data collection use and sharing must be related directly to business practices. One example of data privacy is the General Data Protection Regulation
otherwise called GDPR. This applies to European Union countries. It's all about data privacy within the European Union. But also it deals with data that will be exported outside of the European Union. Microsoft Azure is GDPR compliant. Now if an organization is found to be in breach of GDPR standards, then they could possibly be fined up to 4% of their annual global amount of profit or 20 million pounds.

So whichever one is greater. So there's definitely an incentive then for European Union organizations that will work with data to make sure that they adhere with the GDPR. Then we've got the National Institute of Standards and Technology, otherwise called NIST. This is a set of international standards, some of which are related to IT security, so the cybersecurity framework, which focuses on things like critical infrastructure.

Now critical infrastructure would be things like the power grid, water supplies, dams, that type of thing. And also, sensitive data related to that hosted by cloud providers. Now there are many different types of publications such as NIST Special Publication or SP 800-122. This specifically is the guide to protecting the confidentiality of Personally Identifiable Information or PII, P-I-I.

And it relates to things like strong access control and protection of data at rest. But in order for us to implement these types of security controls in accordance with these types of data privacy frameworks, we need to first identify things like Personally Identifiable Information within the organization and the systems that will process and store that type of information.

And then, we have to think about minimizing the collection and use of Personally Identifiable Information so that it only is used strictly for business-related purposes. There are many other bodies of frameworks related to data privacy, including the International Standards Organization, ISO. This is international, and one of the many standards is ISO/IEC 27017:2015. And this deals with cloud computing security controls, related to things like access control. So being authenticated and then authorized to use specific cloud services or resources.

Cloud tenant isolation or separation from one another. And also the secure removal of cloud tenant data so that there are no artifacts that can be retrieved by unauthorized parties after the fact. So with data privacy frameworks, the first thing we have to consider is which data privacy laws and regulations affect the organization.

And then, we need to think about our cloud solution, in this case, Azure, to ensure that we are adhering to those respective laws or regulations. We then need to incorporate data privacy into organizational security policies. And then within the organization, assign responsibility for compliance to laws and regulations. This normally comes in the form of an organizational role called a compliance officer.


The Azure Security Center
The Microsoft Azure Security Center gives you a central place where you can view security related items to be in a better position to enhance your security posture with the use of Azure Cloud Computing Services.
And so here in the Azure Portal, in the navigator on the left at the very bottom, I'm going to click Security Center. But notice everything is gray in the properties blade, and
that's because we need to make sure that we're using a security center plan, and it's not enabled by default. But we're going to go ahead and start a trial, a 30 day free trial to be specific, so if I scroll down here on the far right, I can click Start trial.
So I'm going to go ahead and do that.
And one of the things that it wants to do is install agents within my virtual machines in my Azure subscription, so it knows how secure they are or are not.
So I've got my subscription selected here, I'm going to go ahead and click Install agents. Once that's been done, we can see things become available in the properties blade. And I'm still in the Overview area where we can get a great list of overall suggestions related to security, or rather any security shortcomings related to our Azure environment.
So we can see we've got an overall secure score here of 348 out of 480. Well, that's not 480 out of 480, so let me go ahead and click on that to pull up some details related to that.

[Video description begins] The Secure Score Dashboard displays. It shows a section titled Secure score by category. Here, 4 categories are covered- Compute & apps, Data & storage, Networking, and Identity & access. Progress bars below each category shows the score. A table displays below the scores, and it contains 2 columns titled SUBSCRIPTION and SECURE SCORE. 1 subscription, Pay-As-You-Go, displays in the table. A hyperlink, View recommendations, is present next to this subscription. [Video description ends]

So down below, we can see our subscription, and we can see that we have a View recommendations link up above. You can also click on specific categories like Compute & apps versus Identity & access. Down below, I'm just going to click on View recommendations, so we can see all of them.

[Video description begins] The Recommendations page displays. All 9 resources in different categories display along with their health monitoring score, marked by different colors for different severity levels- red for high severity; orange for medium severity; and blue for low severity. Below this, all recommendations display in a table format with columns titled RECOMMENDATION, SECURE SCORE, and FAILED RESOURCES. [Video description ends]

Well, red naturally might be a problem, so let's see. We've got a problem here with our subscription, it says that we need to enable MFA multi-factor authentication. For accounts that have owner permissions on our subscription, apparently, that's not been done. That's a great point actually. Because with multi-factor authentication, instead of having knowledge of the username and password with overall access to our subscription.

We could add another factor such as requiring a smartphone that has a constantly changing numeric value, that is only good for a few seconds. So, when we have to authenticate, we'd have to specify the numeric code which is only good for a short period of time, in addition to having knowledge of the username and the password. That's a good way to secure our accounts through multi-factor authentication.

And we'll focus more on that in another demo where we focus on identity and access management. It says here we should also enable network security groups on subnets. So remember, you can click on each of these to get more further detail about what that description is for that recommendation.

[Video description begins] He clicks one of the recommendations, Enable Network Security Groups Groups on Subnets, and its page opens. It contains the number of Unhealthy resources and Healthy resources, and a Learn more hyperlink. Remediation steps also display. The page contains tabs- Unhealthy resources, Healthy resources, and Unscanned resources. Unhealthy resources tab is active now and it shows one unhealthy resource- Subnet1. [Video description ends]

So it'll go ahead and tell us the culprit, so to speak here, which in this case, happens to be Subnet1.

[Video description begins] The Subnet1 page opens. It contains fields such as Address range, Available addresses, Network security group, and Route table. [Video description ends]

And when I actually click on that, I can actually see details related to that, such as, the network security group, which is set to none for that specific subnet. So we can drill down and actually solve problems. We can also see here that we don't have endpoint protection installed on virtual machines, for things like anti-malware at least, in this case, for one of two virtual machines.

[Video description begins] He returns to the Recommendations page and hovers over the next recommendation. [Video description ends]

And if I click on that to drill down, we can see here the severity level is high and the culprit here apparently is a virtual machine called eastwindowsvm1.

[Video description begins] The Endpoint Protection not installed on Azure VMs page opens. It contains a table with columns titled VIRTUAL MACHINE, STATE, and SEVERITY. One VM is listed. Its name is eastwindowsvm1 and its state is open and severity is high. The following 2 links display at the top of the page: Filter and Install on 1 VMs. [Video description ends]

So, notice that we've got a link here to install on 1 VM, we can just click it and choose to install Microsoft anti-malware, we can go through and get that done.

[Video description begins] The Select Endpoint Protection page opens. One software, Microsoft Antimalware, displays here. [Video description ends]

[Video description begins] The Microsoft Antimalwareinstallation page displays. [Video description ends]

So not only does it point out any security deficiencies but it gives us a very convenient and easy way to solve the problem. Now, of course, if you have that problem on hundreds of virtual machines, that's probably not the best way to deal with it, however, it does work.

Now here, we've got Install on 1 VMs because that is what happens to be selected here. So if we select a bunch of them, for example, hundreds of them, then we can have the ability to install that endpoint protection agent on hundreds of VMs at once, so it's very convenient. 
As we go further down the list in the Azure Security Center, we can also see it suggests that we don't have disk encryption applied on virtual machines for protection of data at rest, so we can go ahead and do that. So the security center that is designed to give us details on any security shortcomings in our Azure environment, along with the convenient way to address those concerns.


Azure Service Trust Portal
  - The Microsoft Azure Service Trust Portal allows us to track compliance, to run audit reports on that compliance. And also to focus on data protection in line with laws and regulations. The Azure Service Trust Portal allows us to work with the Compliance Manager. This allows us to be compliant with different data protection regulations including HIPAA, GDPR, ISO 27001, to name just a few.
We can also track our compliance with specific rules that need to be followed, and we can also even assign compliance responsibility. In the Azure Service Trust Portal, another aspect is auditing. Where we can run audit reports for compliance with standards related to ISO, PCI DSS for cardholder data protection, FedRAMP, SOC, otherwise called SOC.
So for example, SOC3 allows organizations to adhere to rules for internal controls within an organization for things like business processes and the integrity of those business processes. Finally, the Azure Service Trust Portal also deals with data protection, where documentation is made available. There is also mappings made between data privacy frameworks, a variety of them, to the Azure security controls will allow organizations to be compliant in those specific regards. There are also frequently asked question documents and white papers that are available for Azure IT technicians.


Block Public SSH and RDP Traffic
When you deploy Linux and Windows virtual machines into Azure, you probably want to remotely manage them from on-premises. And so you might use SSH to get into Linux hosts or the remote desktop protocol client to get into Windows hosts. The problem is we don't want that type of accessibility through a public IP address on each VM.
Instead ideally, we would use a point to site VPN connection from our administration on-premises to Azure, and then SSH or RDP to the private IP address of those VMs. So here in the Azure Portal, why don't we start by going into the Virtual machines view on the left?
Let's start with our eastlinuxvm1 virtual machine that's running Linux.
Now, the first thing I notice is it does have a public IP address. Well, if that's only for the purpose of allowing inbound administration, that's a problem. So what we're going to do is click on Networking over on the left as well.
And I can see here that if we look at the effective security rules, I'll click on Effective security rules. And the virtual machine has to be running for effective rules to display here. We'll then see that we've got access that would be allowed here into the virtual machine over a specific port.
So for example, we've got a port 22 rule from any source that's allowed to get to any destination on TCP port 22, which is SSH. However, do we really want to allow that coming in? The answer is no. And at the same time, we really don't need a public IP address if that's the sole purpose of it for this Linux virtual machine.

So let's clean this up a little bit. We're going to go ahead and close out some of these things. I'm going to go back to Networking, where notice we've got the public IP listed here for this Linux virtual machine.

[Video description begins] He returns to the Networking page and clicks the link under the Public IP field . A page titled pubIP1 opens. The page has buttons titled Associate, Dissociate, Move, Delete, and Refresh. [Video description ends]

And when I click the link, it takes me into that because it's a separate Azure resource, the public IP. I'm going to click Dissociate. Now I'm going to do that so

[Video description begins] When he clicks Dissociate, a confirmation window pops up and he clicks Yes in it. [Video description ends]

that it's not associated any longer with the Linux virtual machine.

[Video description begins] A window with the text: Saving network interface- pops up in the top-right corner of the page. [Video description ends]

And if this public IP address resource isn't needed for anything else, I can even go ahead and delete the resource. It's always a good idea to delete Azure resources that you are certain you no longer need. Because then you're not incurring any additional charges, plus it just makes management of your Azure resources a little bit more streamlined.

[Video description begins] A window with the text: Saved network interface- displays. [Video description ends]

Now, at the same time, I'm going to close out of that and go back to the Networking part of the properties blade for my Linux virtual machine. Because I'm interested in looking at the network security groups here. So I've got a couple of network security groups.

Remember, if we click on Effective security rules, if the VM's running, we'll see all effective security rules that apply to this particular virtual machine at this point in time. And here, I've got a network security group for the VM itself and then another one for a subnet. And if I click on these links, notice I can see where the rules comes from. And so the Port_22 item is from the eastlinuxvm1-nsg, or network security group. I'm going to go ahead and click on that so we can look at the inbound rules.

[Video description begins] The eastlinuxvm1 -nsg page opens and he clicks the Inbound security rules menu in the Settings menu group in the navigator. On the right, the rules display in a table containing columns titled PRIORITY, NAME, PORT, PROTOCOL, SOURCE, DESTINATION, and ACTION. 4 rules display in the table. [Video description ends]

Here is the Port_22 rule, so I'm going to go ahead and select that and delete the rule, why?

[Video description begins] The Port_ 22 pane displays on the extreme right. It has 4 buttons titled Save, Discard, Basic, and Delete. When he clicks Delete, a confirmation window displays and he clicks Yes in it. [Video description ends]

Because we don't need it. What we're going to be doing, as we've seen in another demo, is connecting our on-premises station through a VPN to Azure, that's called a point to site VPN. After which, we can then connect to the private IP of the virtual machine.

[Video description begins] He clicks Overview in the navigator. [Video description ends]

So let's just go ahead and close out of this network security group, we can see the rule's been removed. And back here, let's just close the network interface actually. We've got all kinds of levels of resources we're into. Now let's go back to the overview for the VM itself. So what we're going to be interested in then is noting that we no longer have a public IP address. But if I go ahead and click on Networking on the left, we can see the private IP for this host.

[Video description begins] He highlights the value in the Private IP field. [Video description ends]

And so the private IP then is going to go ahead and allow us to make a connection to that host once we have VPNed into the network environment. And just bear in mind that the default rule here, AllowVnetInbound will allow connectivity for resources on the VNET to resources in that same VNET, like our Linux virtual machine.

[Video description begins] He hovers over the AllowVnetInBound port rule in the displayed table. [Video description ends]

So we could go ahead and follow this practice and apply it to all the virtual machines that we don't want publicly accessible for remote management purposes.
