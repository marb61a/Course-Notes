                    AZ900 Microsoft Azure Cloud Fundamentals 2021
                    Course Notes Part 42


Network Security Groups
  - Azure network security groups, or NSGs, are resources in Azure 
    - That get associated with other resources like NICs, network interface cardsused by virtual machines, or subnets
  - So we're talking about inbound network security rules to control traffic coming into Azure, or even traffic leaving Azure in an outbound direction
    - But that inbound and outbound protection is associated at the NIC level for a specific virtual machine or, a little bit more generally, at the subnet level
    - So certainly, if you've got a subnet with a bunch of Linux machines that you want to be able to administer
    - You might allow inbound SSH, either to one jump box or to all of them
  - You could do that through a network security group associated with the subnet
    - However, when it comes to associating network security groups with things like network interface cards used by DMs
    - Bear in mind that only one network security group can be associated with a network interface card
  - Azure network security groups support Allow as well as Deny actions, depending on what your requirements are
    - There are also a series of default rules to allow things like load balancing, to allow Inter-VNet communication
    - Of course, incoming Internet traffic initiated from the Internet is blocked by default
    - Outbound Internet traffic, however, is allowed by default.
  - When you use the portal to create a network security group, or an NSG, it's going to look something like this
    - Specifically, this is a rule being created within the NSG, where at the top we specify the Source, in this case it's IP Addresses
    - We can control either a specific IP address or a range of IP addresses
    - We can specify a source port range or just a single port from which the traffic is initiated from
    - Then we have to specify the Destination, because this is an inbound rule
    - In this case, it could be a virtual network, it could be a specific virtual machine IP address and we can see here the Destination port of 80.
  - We can specify the Protocol as being TCP, UDP, or Any. And then, of course, we determine whether we want to Allow or Deny this traffic
    - In this case we are allowing it, the Priority value is relative to other items
    - Here we've got a Priority for 100 in this rule, if we have another rule with a priority of 300, well this rule will get checked first
    - If there's a match with the incoming traffic, rule processing stops. Otherwise, it would continue on to the next rule with a priority of 300
    - Then, of course, we have a name that we can assign to the rule.
  - We can see a number of inbound security rules listed together for a network security group
    - We can see the first rule, PRIORITY 100, is the rule we just looked at a moment ago for port 80
    - Because that has the smallest priority number, at least value-wise numerically, it gets checked first
    - On the far right, you can see the ACTION is to Allow it if incoming traffic matches those conditions
  - The next three, the last three also, are default rules
    - We can click the Default rules button pictured here in the screenshot to hide them if I don't want to see them
    - But allowing inbound VNet traffic and load balancing is allowed by default
    - But after that, notice the last rule at the bottom is to DenyAllInbound traffic if there is not a match from above
  - Network security groups in Azure can be managed using the Azure portal GUI
    - Or using PowerShell cmdlets such as New-AzNetworkSecurityGroup, Get-AzNetworkSecurityGroup to retrieve a list of them
    - We can remove a security group with Remove-AzNetworkSecurityGroup
  - However, there are also PowerShell cmdlets to manage the rules within the network security group
    - At the CLI level, we can use az network nsg create, naturally to create the network security group
    - We can list them, and of course we can delete them using the appropriate syntax


Network Security Group GUI Management
  -In Azure, network security groups are often simply referred to as NSGs and they are used to control traffic into and out of VNet subnets
    - To get started here, let's take a look at an existing configuration and then we'll build a new one
    - In the portal, start by clicking on Virtual networks over on the left, and click on one of the existing virtual networks to pull up its properties blade
    - Now the first thing I want to do here is look at the subnet affiliation or association to the selected VNet
    - And on the right, we can see that we've got a number of subnets such as EastSubnet1, for example, that is associated with this virtual network
    - Notice under the SECURITY GROUP column, we can see the network security group associated with that particular subnet, in this case, NSG1
    - Therefore, if we go to All resources and If we were to filter by NSG among other things
    - We will certainly see NSG1, the network security group we were just talking about
  - If we go ahead and click on that to pull up its properties blade, it has a set of inbound security rules to control traffic into
    - In this particular case, the way it's being used, the subnet, and also outbound security rules
    - When we go to both inbound and outbound security rules, we can hide the built in default rules
    - Which, if you look at their priority values fall towards the bottom of the list of rules
    - The rules are matched against, in this case, incoming traffic starting at the very top based on the priority
    - Then going further down to the next priority value and so on and so forth
    - When there is a match, rule processing starts, that is also true when it comes to outbound security rules
  - Go look at our virtual machines, if we were to pop up the properties blade of a virtual machine
    - If we were to click on Networking, we would also see the VNet and the subnet association, but also the network security group
    - Notice here that we've got NSG1, that's network security group 1, attached to a subnet
    - We can see that the rules are showing up in here
    - Also notice that if the virtual machine were running, we'd be able to click Effective Security Rules 
    - So that we would be able to see all of the rules in effect if we've got more than one particular security group
    - Because you might have a network security group associated to a virtual machine specifically
  - We are going to go to the Create a resource button in the upper left, and here under the Networking section 
    - We are actually going to create a network security group
    - When we do that, we have to come up with a name for it
    - If this is going to be, let's say for the Windows environment for an application that has many resources like a back end database
    - Some virtual machines, a load balancer and what not, maybe we would call this, WebApp1_ NSG, if it's for that purpose
    - Then we have to deploy it into either an existing resource group or create new resource group, specify the location, and then  simply click Create
  - That's not the end of the story with network security groups, though of course
    - Because they need in and outbound rules configured appropriately so that they can be used
    - Then, of course, they need to be associated with things like subnets so they're actually effective
  - Go to All resources here, let's just look or filter for NSG, here's WebApp1 NSG, then click on that
    - For inbound security rules, we've got the default rules, because if we hide them we see nothing
    - Same with the outbound rules, we've got the default rules
  - However we want to add a rule to allow inbound traffic
    - Because this is for a web app, we are going to click Add to add a rule
    - The source will be Any and we can specify Source port range on the request
    - We can also specify a destination of Any, or we could specify an IP Address if we know
    - For instance, we've got a fixed IP address, a static, unchanging IP address, that we are using for a virtual machine, that we can pop that in here
  - If we know that the destination port is 443, it's an HTTPS connection type of application only
    - We know that's happening over TCP port 443, and we want to allow it
    - Again, we've got a priority value here and we need to give it a name for example call this AllowinboundHTTPS, and then click Add
  - Once we've added the security rule or security rules to our liking
    - We're then ready to make this effective by associating this network security group with something, and those somethings could include a subnet
    - If we go to Subnets, we can click Associate and can choose, first, a virtual network and then choose the appropriate subnet to which we want that applied
  - We are going to exit out of there because we can also associate this with a network interface that's tied to a virtual machine
    - We could have a network security group for an entire subnet
    - But there are times when you might have a single virtual machine which is linked to a network interface 
    - That has specific in or outbound network traffic security rule requirements
    - In that case, you could associate your network security group with a specific network interface

