                    AZ900 Microsoft Azure Cloud Fundamentals 2021
                    Additional Material Course Notes Part 27


Azure Monitoring Overview
  - In order to keep your Azure environment secure and running optimally, you should perform monitoring.
    - In order to monitor something to determine if something is abnormal, you need to know what is normal
    - That's where monitoring baselines kick in, whether it's for determining what normal activity looks like at the network level
    - For the amount of network transmissions, for example, what is normal when it comes to activity on a host
    - Such as how much memory is usually used within normal workload conditions, or how busy the CPU is
    - That also goes for an application, which could be spread out across multiple virtual machine hosts
    - Monitoring baselines will vary from one company to another, even from one department within an organization to another
    - Depending on how technology is being used. So an anomaly from the normal usage could indicate a security incident
    - It could just be a normal spike in activity, but if we gather enough activity over time, we'll know that that occurs.
  - So a security baseline then can be used to detect anomalies
    - Performance baselines can also be used simply to detect that things are busy or that they have slowed down
    - In response we might resize virtual machine instances
    - Or configure autoscaling accordingly to accommodate the increase or decrease in those workloads
    - So baseline anomalies could show up as busy CPU utilization
    - Which could be indicative beyond of just a busy workload of cryptocurrency mining, if the machine has been infected, or ransomware
    - If we have excessive network traffic way beyond normal that could be indicative of a distributed denial of service or a DDoS network attack
    - Or we might have device operating system changes while the hardware is the same
    - Now that would mean that we might have a Windows host that is all of a sudden a Linux host, but everything else about it looks the same
    - So that could be indicative of someone having infected the machine or maybe booted it from a USB drive into a different OS, and so on
    - The other thing to think about is system and data access outside of regular work hours at irregular times
    - So there are a lot of different aspects of Azure resources that we might monitor to determine if there's an anomaly of some kind.
  - Now Azure monitoring gives us a number of options to track this stuff, including centrally
    - So we can monitor Azure resource activity logs
    - Now these activity logs are essentially audit logs of management tasks applied to Azure resources
    - Such as starting and stopping a VM or reconfiguring a VM or a web app
    - We can also look at the Azure Performance Diagnostics Windows VM extension
    - If you enable performance diagnostics, then you're getting more details on metrics like CPU utilization and traffic in and out
    - Disk I/O activity, for monitoring purposes, you can also pin a lot of these items to custom dashboards
    - So that you can pull up a dashboard and see what's of relevance for you when it comes to monitoring your Azure environment
    - You can also work with Azure Application Insights if you want to track activity and performance metrics for a specific web app
    - So that's really what that one is about.
  - Here on the screen we have a screenshot of monitoring some performance metrics for an individual VM or virtual machine
    - We can see the CPU average utilization, the network traffic total, the disk bytes total, the disk operations per second on average
    - These are important metrics to monitor. However, we can also monitor things centrally 
    - Instead of doing this and going to an individual Azure resource, in this case a VM.
  - That's where Log Analytics workspaces kick in. This is centralized monitoring of Azure log data and also performance metric data
    - Configuration and log data feeds into Azure Monitor from the Log Analytics workspace
    - You can also run log queries in the Log Analytics workspace
    - Or from Azure Monitor, again, because Azure Monitor gets a lot of its data from Log Analytics workspaces
    - Your alert notifications can be configured in the Log Analytics workspace
  - Now, there are a number of data sources that Log Analytics workspaces draw upon
    - Including storage account logs, Azure activity logs, physical and virtual servers
    - And you can even link it to your existing System Center Operations Manager or SCOM environment, if you have one
    - By adding servers to the Log Analytics workspace
    - It means that their performance metrics and log data can be collected centrally in the Log Analytics workspace.


Individual Resource Monitoring
  - There's a wealth of information available for each and every Azure resource 
    - Whether you're interested in monitoring the performance of an item or auditing who did what to it from a management perspective 
    - Or viewing things like operating system log details for VMs. 
  - All of this is available here in the portal, we are going to start in the portal by clicking to open up an existing virtual machine.
    - The first thing we're going to do is click on the Activity log on the left.
  - This is a log that really only relates to the management of this resource in Azure
    - On the right the default Timespan is the Last 6 hours, get more stuff shown here by changing that, to the Last month click Apply
  - Now we'll see that there are quite a few other operations related to the management of this VM
    - When we filter in that way we can see the name of the operation, whether it succeeded or not
    - The date and time stamp, the subscription it applies to and the user that initiated it
    - We can also further filter this, for example, for Event severity
    - Let's say the only thing we are really interested in are Critical and Error messages, we are not interested in seeing Warning or Informational
  - We can unselect those or deselect them and now we've got a really small filtered list
    - We can click on any one of these specific activity log entries to get more detail.
    - Now, we also have other options for monitoring here.
  - We are going to scroll way down in the navigation bar down to the Monitoring section where we will click on Metrics
    - This is more related to the performance in this case of the VM.
    - So we can select a metric from the drop-down list, for example just go down in this list and choose Percentage CPU.
  - Now the Percentage CPU item is added here and we can see its value
    - We can see it's been plotted against the timeline on the bottom, and the percentage going across the top, from the bottom to the top.
    - We can also add metrics, you have more than one thing shown at the same time.
  - We going to go ahead and maybe and add Disk Read Bytes/second. And when you do that it will be plotted.
    - You'll see it might have a value,we can see the values are being plotted but notice in the legend it's a different color
    - This could be very important as well.
  - We can monitor these metrics to track how this is doing. So performing well, do we maybe need to resize the VM
    - Maybe scale it up so it can handle the workload better? That type of thing, we can also go to Logs over on the left.
  - It's not enabled by default, so we are going to go ahead and click the Enable button
    - When you do that, you're going to have to select the subscription and a Log Analytics workspace that you want this associated with
    - We are okay with the default selection for the Log Analytics workspace so go ahead and click Enable.
  - Once that's enabled and you're still in the Logs blade, over on the right you'll see that things have changed.
    - You've got a query builder tab at the top here, it's called New Query 1
    - So this is a log query and down the left, you have a bunch of table names that you can select from.
    - If you expand any of these table names, what you will be exposing are the fields or columns within those tables.
  - You can see the data type is string or whatever it happens to be depending on the nature of what you're looking at, you can actually start selecting items.
    - For example, if we double-click on one of these items, such as a column, we could see it puts it in here over on the right.
  - Of course you can also select from some example query, go to Performance and availability
    - We could start scrolling down and saying maybe we want to view Virtual Machine available memory and we could run that.
  - It puts in the query statement here, where for example, the name of the table which is case sensitive is Perf
    - Then we are piping that to where and we are asking for TimeGenerated over an hour ago and so on and you can run the query by clicking Run
    - If there are no results, then you're going to get a message that says there are no results
    - Otherwise, you'll see some of the details, this is one thing that we can do here, work with log queries within an individual resource
    - Let's go up to Diagnostic settings here for this Windows virtual machine.
    - We've got a storage account selected here for storage.
    - We are going to choose Enable guest-level monitoring.
  - The next thing we can do is determine under Overview, for example, which performance counters we are interested in gathering
    - There are some default selections, we can go to Logs and determine which operating system logs we are interested in and some details.
    - For example, I'm interested in the Application log with Critical, Error, Warning types of events, severities
    - We could do the same type of thing for the Security and System logs
    - We can even ask for additional items like IIS web server logs if there is one available there.
    - And we can save all of these settings.
  - When you enable the diagnostic settings, you're really saying you want to start to get more details 
    - Of the inner workings of the workloads running in those, in this case in this VM.
