                    AZ900 Microsoft Azure Cloud Fundamentals 2021
                    Additional Material Course Notes Part 31


  - This is what you're going to see the first time you come in
    - It wants you to install the OMS agents, the monitoring agents within your hosts
    - If you added virtual machines to this Log Analytics workspace
    - They automatically already have the Microsoft monitoring agent extension installed, it's already done
    - You can also tweak and configure performance monitoring.
    - You can also tweak and configure service connectivity monitoring such as for Office 365, Microsoft Dynamics.
  - You can also monitor ExpressRoute dedicated circuit connections.
    - Over on the left we are going to click NETWORKS.
  - We've already added a couple of networks here. we've got my default network and we can see the subnetwork range for that VNet is 10.0.1.0
    - However we have also already added VNet9 here
    - You can click the Add network button and just fill in the details for the network name
    - You'll be able to select an unallocated subnet that it's detected down below here, we've done that and called it VNet9. 
    - Then if we click on SUBNETWORKS over on the left, we'll see the subnets that stem from those virtual networks.  
  - If we click on NODES, we can see here that we've got three virtual machines in Azure
    - They're up and running. The AGENT STATUS shows as being Healthy
    - Now these three virtual machines in my case are added to this Log Analytics workspace
    - As we've mentioned, they automatically get the monitoring agent installed, so they're good and ready to go. 
    - If we click PERFORMANCE MONITOR on the left, click add a rule.
    - When we add a rule over on the right, select a network, we can select a subnet, and choose connectivity to another subnet.
    - We can add exceptions and can tell it that we want to use ICMP versus TCP to test the connectivity.
  - We can determine when it will generate an alert if the connectivity between those subnets is not available
    - The default is to autodetect sudden change, but we can say if there is a loss
    - Apacket condition loss, greater than or equal to a certain percentage
    - Or latency, network latency, speed greater than or equal to a certain number of milliseconds
    - Network latency means network slow down issues, we can have that trigger
    - Once we've got that done, then our rule will show up, we can go back to the overview here for our workspace summary.
    - That's when, when you come into Network Performance Monitor, you get to see here that you've got some problems.
  - Potentially, hopefully not. So we know that within a Log Analytics workspace
    - If we scroll down and look at the workspace data sources that virtual machines can serve as a data source.
  - We've got a couple of them here, WinSrv2019-1, -2 and 3, they're added to this workspace
    - Of course, we can just click on it to open it up and connect or disconnect it.
  - Once you actually connect a virtual machine to a workspace, the Microsoft monitoring agent is automatically installed in the VM.
    - That way the VM can report back to this Log Analytics workspace, so just flip over and take a look at one of those virtual machines.
    - If we actually click to open it up, and if we take a look at the virtual machine extensions.
  - What will have been added because it won't have been there before is the Microsoft Azure monitoring dependency agent
    - That gets installed when you connect or link that VM to a workspace
    - Now in the case of Network Performance Monitoring, that's going to be important.
  - If we take a look at the result of our configuration. If we go under Workspace summary here in the Log Analytics workspace.
    - We could see that now that it's had time for those servers to start reporting back information about network connectivity
    - We're going to start seeing some potential alerts, we can see there's an alert here
    - There's 1 of 1 subnetwork link that is considered unhealthy. 
  - If we click on that panel to open it up, then we can read more details about exactly what the issue is
    - We can see that that health event was generated by a rule called Rule1
    - If we kind of click on that rule to see what it's about, we've got a 100% transmission loss.
  - We can see it's between subnets within the rule that were specified
    - In this case, those subnets are the 10.0.1.0 subnet, and the 13.0.1.0 subnet
    - There's a link on the right that says View affected node links, we could also click on that to get even further detail
  - From here we can see the node links where on the left we have the name of a virtual machine
    - It's pointing to another one listed to the right of it
    - We can see the IP address interfaces, and we can see in this case we have a 100% packet loss
    - That often might be due to routing problems between subnets and so on
    - But this is one of the overall purposes of using Network Performance Monitor or NPM in Azure
    - To identify these types of network connectivity issues.


Network Watcher
  - Before you can troubleshoot network connectivity issues in Azure, you need to be aware of the network configuration
    - You've got to know what's there. How many VNets, subnets, VNet peering is enabled and so on.
  - In the portal, we are going to search for network and are going to select Network Watcher from the list.
    - One of the things we can do here is click on Topology over in the left-hand navigation bar to open up the Topology blade.
  - On the right, it's got my subscription automatically selected from the Resource Group drop-down list
    - We are going to choose a resource group that we are interested in here.
    - We can also select a VNet to further filter the topology map.
  - It draws a topology map in a hierarchy, where at the top, we have our virtual network
    - In this case, it's called VNet1 under which we then see the subnets
    - And this is part of knowing what you have
    - If you're called in to troubleshoot something and you didn't set it up, it's helpful to know what's there
    - So we can see we have a number of subnets, including a GatewaySubnet, an AzureFireWallSubnet, an AzureBastionSubnet
    - Under each subnet we can then see the associated network interfaces 
    - And ultimately the public IP addresses associated with those interfaces and of course the virtual machines
    - This is one of the things we can do with the Network Watcher tool, is learn a bit about our topology in the Azure environment
    - Over on the left, we can also click on Connection monitor.
    - We can click the Add button over on the right to add a connection monitor.
    - We are going to call this Monitor1.
  - We are going to select a virtual machine here that would be a virtual machine 
    - That is the source we want to monitor from and then we want to select a destination virtual machine.
    - We can also specify a port number on which we want that connectivity to be checked.
    - We'll put in Port 80 and  just click Add to add that connection monitor.
    - We can now see the monitor has been added to the list and under the Status column it says it is currently running.
  - We can actually click on that connection monitor configuration and that'll open up another panel down below 
    - Where we can scroll down and see some details over the last hour, six hour all the way up to the last 30 days
    - And down below according to the legend, we can see that we've got percentage of probes that have failed is 100
    - That's not good. Well, that could be due to a number of reasons
    - Perhaps the target virtual machine isn't reachable due to routing problems
    - But if they're in the same subnet, it's not a routing issue
    - Or it could be a network security group preventing connectivity to a port
    - Or perhaps Port 80 simply isn't in a listening state on that machine, there's no web server
    - So there are plenty of reasons that could happen, but we can identify that this is happening here using Network Watcher
    - We can also run a Packet capture as we can see over here on the left, we can view our Effective security rules, network security group security rule.
    - From here we can select the subscription, a resource group and ultimately a virtual machine.
  - When we do that we can see a network interface for that virtual machine 
    - And the association with the network security group here at the subnet level that says 
    - As opposed to linked directly to the network interface, and we can see any rules that might be applicable.
    - We can also click on Packet capture on the left and click the Add button to add a packet capturing session.
  - Sometimes you'll create a packet capturing session because you want to be able to actually examine 
    - The detailed specific network traffic that is occurring on a network.
    - Specifically what you're going to do is to choose the target virtual machine that you're interested in
    - And you can select to store the resultant packet file name, the packet capture file name in a storage account
    - Or you can have it stored in a file within the virtual machine in question
    - The target virtual machine that we have to select above or you can have it stored in both places
    - The packet capture file will use a .cap format. So you can open it up with standard tools like Wireshark.

                    
